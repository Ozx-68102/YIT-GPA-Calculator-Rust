{% extends "base.html" %}

{% block title %}结果显示{% endblock title %}

{% block style %}
<style>
    .section-title {
        text-align: center;
        padding: 20px;
    }

    #result-table {
        margin: 0 auto; /* 居中 */
        width: 80%; /* 控制表格宽度 */
        border-collapse: collapse;
    }

    #result-table th {
        background-color: #007BFF;
        color: white;
        font-weight: bold;
        text-align: center;
        padding: 10px;
    }

    #result-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
    }

    #result-table tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    #result-table tr:hover {
        background-color: #cce5ff;
    }
</style>
{% endblock style %}

{% block body %}
<nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
        <div class="navbar-brand user-select-none">GPA查询</div>
        <div class="navbar-nav">
            <div class="nav-item">
                <div class="form-check form-switch d-inline-block">
                    <input class="form-check-input" id="gpa-mode-switch" role="switch" type="checkbox">
                    <label class="form-check-label" for="gpa-mode-switch">计算全部课程</label>
                </div>
            </div>
        </div>
        <div class="nav-item">
            <button class="btn btn-warning me-2" id="logout-button">退出登录</button>
            <button class="btn btn-danger me-2" id="shutdown-button">关闭程序</button>
        </div>
    </div>
</nav>

<div class="container py-4">
    <div class="alert alert-dismissible fade show d-none" id="shutdown-alert-placeholder-content" role="alert"></div>
</div>

<div class="container py-4">
    <div class="section-title row justify-content-center">
        <div class="col-lg-10">
            <div class="section-title text-center mb-4 p-3 bg-light rounded shadow-sm">
                <h2>平均绩点</h2>
                <h2 class="fw-bold text-danger" id="gpa-display">{{ gpa }}</h2>
            </div>

            <div class="text-center mb-4 p-3 border rounded" id="excluded-courses-notice">
                <h2>不计入绩点计算的课程:</h2>
                <p class="text-muted">
                    公选课、体育、通识教育选修课、职业生涯规划与就业指导、大学生安全教育、大学生心理健康教育、</p>
                <p class="text-muted">
                    形势与政策、军事理论、军事训练、创新创业教育、劳动教育、专业基础认知、入学教育、毕业教育、</p>
                <p class="text-muted">社会实践、社会调研、综合实训、综合设计与展示、职场体验、</p>
                <p class="text-muted">实习（如金工实习，认知实习,
                    电工电子实习，毕业实习等）、见习（如教育见习，专业见习等）、</p>
                <p class="text-muted">名师大讲堂、领导力、系列讲座</p>
            </div>
        </div>
        <h3 class="text-danger">仅供参考，实际情况以教务处为准</h3>
    </div>

    <div>
        <table class="table table-striped table-bordered table-hover" id="result-table">
            <thead>
            <tr>
                <th>序号</th>
                <th>课程</th>
                <th>学分</th>
                <th>成绩</th>
                <th>绩点</th>
                <th>加权绩点</th>
            </tr>
            </thead>
            <tbody id="result-table-body">
            {% for course in courses %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ course.name }}</td>
                <td>{{ course.credit }}</td>
                <td>{{ course.score }}</td>
                <td>{{ course.grade }}</td>
                <td>{{ course.credit_gpa }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 关闭程序确认模态框 -->
<div aria-hidden="true" aria-labelledby="shutdown-confirm-modal" class="modal fade" id="shutdown-confirm-modal"
     tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shutdown-confirm-title">确认关闭吗？</h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <div class="row col-12">
                    <p id="shutdown-confirm-text">
                        是否关闭此程序？关闭后，网页将不再响应后续操作，需要重新启动程序登录后才可继续使用。
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
                <button class="btn btn-danger" id="shutdown-confirm-submit" type="button">确认关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 退出登录确认模态框 -->
<div aria-hidden="true" aria-labelledby="logout-confirm-modal" class="modal fade" id="logout-confirm-modal"
     tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logout-confirm-title">确认退出登录吗？</h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
                <button class="btn btn-warning" id="logout-confirm-submit" type="button">确认退出</button>
            </div>
        </div>
    </div>
</div>

<script type="application/javascript">
    // 网页加载完成后执行
    document.addEventListener("DOMContentLoaded", () => {
        // 初始化 Toast
        const toastElement = document.getElementById("error-toast");
        const toastBody = toastElement.querySelector(".toast-body");
        const toast = new bootstrap.Toast(toastElement, {autohide: false});

        // GPA 切换的逻辑
        const modeSwitch = document.getElementById("gpa-mode-switch");
        const GPADisplay = document.getElementById("gpa-display");
        const tableBody = document.getElementById("result-table-body");
        const excludedCoursesNotice = document.getElementById("excluded-courses-notice");

        const noticeForAllMode = `
        <h2>不计入绩点计算的课程:</h2>
        <p class="text-muted">入学教育（0学分）</p>
        `;
        const noticeForDefaultMode = `
        <h2>不计入绩点计算的课程:</h2>
        <p class="text-muted">公选课、体育、通识教育选修课、职业生涯规划与就业指导、大学生安全教育、大学生心理健康教育、</p>
        <p class="text-muted">形势与政策、军事理论、军事训练、创新创业教育、劳动教育、专业基础认知、入学教育、毕业教育、</p>
        <p class="text-muted">社会实践、社会调研、综合实训、综合设计与展示、职场体验、</p>
        <p class="text-muted">实习（如金工实习，认知实习, 电工电子实习，毕业实习等）、见习（如教育见习，专业见习等）、</p>
        <p class="text-muted">名师大讲堂、领导力、系列讲座</p>
        `;

        /** 根据新的GPA数据刷新网页内容
         * @param {object} data GPA 课程数据
         * @return {void}
         */
        function updatePage(data) {
            // 更新 GPA 显示
            GPADisplay.textContent = data.gpa;

            // 更新提示文字的显示状态
            if (modeSwitch.checked) {
                excludedCoursesNotice.innerHTML = noticeForAllMode;
            } else {
                excludedCoursesNotice.innerHTML = noticeForDefaultMode;
            }

            // 加载课程表格
            tableBody.innerHTML = "";   // 先清空
            if (data.courses && data.courses.length > 0) {
                data.courses.forEach((course, index) => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${course.name}</td>
                        <td>${course.credit}</td>
                        <td>${course.score}</td>
                        <td>${course.grade}</td>
                        <td>${course.credit_gpa}</td>
                    `;
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-danger">没有可用于计算的课程。</td></tr>`
            }
        }

        // GPA 切换开关状态是否被改变 / 是否被选中
        modeSwitch.addEventListener("change", async () => {
            const isChecked = modeSwitch.checked;
            const mode = isChecked ? "all" : "default";

            // 显示加载状态
            GPADisplay.textContent = "计算中...";
            tableBody.innerHTML = `<tr><td colspan="6">正在重新计算...</td></tr>`;

            try {
                const response = await fetch("/recalc", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({mode: mode})
                });

                if (!response.ok) {
                    const errorMsg = await response.text();
                    toastBody.textContent = errorMsg || "未知错误";
                    toast.show()
                    return false;
                }

                const data = await response.json();
                updatePage(data);
            } catch (error) {
                GPADisplay.textContent = "计算失败";
                tableBody.innerHTML = `<tr><td colspan="6" class="text-danger">计算失败</td></tr>`;
                toastBody.textContent = `意外异常: ${error.message}`;
                toast.show();
            }
        });

        // 关闭功能逻辑
        const shutdownBtn = document.getElementById("shutdown-button");
        const confirmShutdownModal = new bootstrap.Modal(document.getElementById("shutdown-confirm-modal"));
        const confirmShutdownTitle = document.getElementById("shutdown-confirm-title");
        const confirmShutdownText = document.getElementById("shutdown-confirm-text");
        const confirmShutdownBtn = document.getElementById("shutdown-confirm-submit");
        const shutdownAlertPlaceholder = document.getElementById("shutdown-alert-placeholder-content");

        shutdownBtn.addEventListener("click", () => {
            confirmShutdownTitle.textContent = "确认关闭吗？";
            confirmShutdownText.textContent = "是否关闭此程序？关闭后，网页将不再响应后续操作，需要重新启动程序登录后才可继续使用。";
            confirmShutdownBtn.textContent = "确认关闭";
            confirmShutdownBtn.disabled = false;
            confirmShutdownModal.show();
        });

        // 这里不使用括号函数是因为其直接继承外部的 this
        confirmShutdownBtn.addEventListener("click", async function () {
            shutdownBtn.disabled = true;
            this.disabled = true;
            this.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>正在关闭...`;

            try {
                await fetch("/shutdown", {method: "POST"});

                confirmShutdownModal.hide();
                shutdownAlertPlaceholder.textContent = "程序已成功退出，请手动关闭此浏览器选项卡。";
                shutdownAlertPlaceholder.classList.add("alert-danger");
                shutdownAlertPlaceholder.classList.remove("d-none");

                shutdownBtn.textContent = "程序已关闭";
                modeSwitch.disabled = true;
            } catch (error) {
                confirmShutdownModal.hide();

                toastBody.textContent = `关闭失败: ${error.message}`;
                toast.show();

                shutdownBtn.disabled = false;
                this.disabled = false;
            }
        });

        // 退出登录逻辑
        const logoutBtn = document.getElementById("logout-button");
        const confirmLogoutModal = new bootstrap.Modal(document.getElementById("logout-confirm-modal"));
        const confirmLogoutTitle = document.getElementById("logout-confirm-title");
        const confirmLogoutBtn = document.getElementById("logout-confirm-submit");

        logoutBtn.addEventListener("click", () => {
            confirmLogoutTitle.textContent = "确认退出登录吗？";
            confirmLogoutBtn.textContent = "确认退出";
            confirmLogoutBtn.disabled = false;
            confirmLogoutModal.show();
        });

        confirmLogoutBtn.addEventListener("click", async function () {
            this.disabled = true;
            this.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>正在退出...`;

            try {
                await fetch("/logout", {method: "POST"});
                window.location.href = "/";
            } catch (error) {
                confirmLogoutModal.hide();

                toastBody.textContent = `退出失败: ${error.message}`;
                toast.show();

                this.disabled = false;
            }
        });
    });
</script>
{% endblock body %}