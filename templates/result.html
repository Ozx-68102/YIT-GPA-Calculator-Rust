{% extends "base.html" %}

{% block title %}结果显示{% endblock title %}

{% block style %}
<style>
    .section-title {
        text-align: center;
        padding: 20px;
    }

    #result-table {
        margin: 0 auto; /* 居中 */
        width: 80%; /* 控制表格宽度 */
        border-collapse: collapse;
    }

    #result-table th {
        background-color: #007BFF;
        color: white;
        font-weight: bold;
        text-align: center;
        padding: 10px;
    }

    #result-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
    }

    #result-table tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    #result-table tr:hover {
        background-color: #cce5ff;
    }
</style>
{% endblock style %}

{% block body %}
<script id="course-rules-data" type="application/json">
    {
        "excluded_courses": {{ excluded_courses_keyword | json_encode(pretty=false) | safe }},
        "permanent_ignored_courses": {{ permanent_ignored_courses | json_encode(pretty=false) | safe }}, 
        "nature_exclusions": {{ nature_exclusions | json_encode(pretty=false) | safe }}
    }
</script>


<nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
        <div class="navbar-brand user-select-none">GPA查询</div>
        <div class="nav-item">
            <div class="form-check form-switch d-inline-block">
                {% if result_mode == "login" %}
                <input class="form-check-input" id="gpa-mode-switch" role="switch" type="checkbox">
                <label class="form-check-label" for="gpa-mode-switch">计算全部课程</label>
                {% else %}
                <h5>免登录模式</h5>
                {% endif %}
            </div>
        </div>
        <div class="nav-item">
            <button class="btn btn-warning me-2" id="logout-button">注销此会话</button>
            <button class="btn btn-danger me-2" id="shutdown-button">关闭程序</button>
        </div>
    </div>
</nav>

<div class="container py-4">
    <div class="alert alert-dismissible fade show d-none" id="shutdown-alert-placeholder-content" role="alert"></div>
</div>

<div class="container py-4">
    <div class="section-title row justify-content-center">
        <div class="col-lg-10">
            <div class="section-title text-center mb-4 p-3 bg-light rounded shadow-sm">
                <h2>平均绩点</h2>
                <h2 class="fw-bold text-danger" id="gpa-display">{{ gpa }}</h2>
            </div>

            <div class="text-center mb-4 p-3 border rounded" id="excluded-courses-notice"></div>
        </div>
        <h3 class="fw-bold text-danger">绩点与计算规则仅供参考，实际情况请以教务处数据为准</h3>
    </div>

    <div>
        <table class="table table-striped table-bordered table-hover" id="result-table">
            <thead>
            <tr>
                <th>序号</th>
                <th>课程</th>
                <th>学分</th>
                <th>成绩</th>
                <th>绩点</th>
                <th>加权绩点</th>
            </tr>
            </thead>
            <tbody id="result-table-body">
            {% for course in courses %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ course.name }}</td>
                <td>{{ course.credit }}</td>
                <td>{{ course.score }}</td>
                <td>{{ course.grade }}</td>
                <td>{{ course.credit_gpa }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script type="application/javascript">
    // 网页加载完成后执行
    document.addEventListener("DOMContentLoaded", () => {
        // 初始化 Toast
        const toastElement = document.getElementById("error-toast");
        const toastBody = toastElement.querySelector(".toast-body");
        const toast = new bootstrap.Toast(toastElement, {autohide: false});

        // GPA 切换的逻辑
        const modeSwitch = document.getElementById("gpa-mode-switch");
        const GPADisplay = document.getElementById("gpa-display");
        const tableBody = document.getElementById("result-table-body");
        const excludedCoursesNotice = document.getElementById("excluded-courses-notice");

        // 业务规则
        const courseRules = JSON.parse(document.getElementById("course-rules-data").textContent);

        /**
         * 根据模式和后端提供的规则动态渲染提示区域
         * @param {string} mode `default` 或 `all`
         * @return {void}
         */
        function renderNotice(mode) {
            let titleHTML = "<h2>不计入绩点计算的课程:</h2>";
            let contentHTML;

            if (mode === "all") {
                contentHTML = courseRules.permanent_ignored_courses.map((name) => `<span class="badge bg-secondary fs-6 px-3">${name}</span>`).join(" ").replace("入学教育", "入学教育 (0学分)");
            } else {
                const allExclusions = [
                    ...courseRules.nature_exclusions,
                    ...courseRules.excluded_courses,
                    ...courseRules.permanent_ignored_courses
                ];
                const uniqueExclusions = [...new Set(allExclusions)];
                contentHTML = uniqueExclusions.map((name) => `<span class="badge bg-secondary fs-6 px-3">${name}</span>`).join(" ").replace("入学教育", "入学教育 (0学分)");
            }

            excludedCoursesNotice.innerHTML = `
            ${titleHTML}
            <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
                ${contentHTML || "<span class='text-muted small'>无</span>"}
            </div>
            `;
        }


        /** 开关存在时, 根据新的GPA数据刷新网页内容
         * @param {object} data GPA 课程数据
         * @return {void}
         */
        function updatePage(data) {
            // 更新 GPA 显示
            GPADisplay.textContent = data.gpa;

            renderNotice(modeSwitch.checked ? "all" : "default");

            // 加载课程表格
            tableBody.innerHTML = "";   // 先清空
            if (data.courses && data.courses.length > 0) {
                data.courses.forEach((course, index) => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${course.name}</td>
                        <td>${course.credit}</td>
                        <td>${course.score}</td>
                        <td>${course.grade}</td>
                        <td>${course.credit_gpa}</td>
                    `;
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-danger">没有可用于计算的课程。</td></tr>`
            }
        }

        // GPA 切换开关状态是否被改变 / 是否被选中 (前提是开关存在)
        if (modeSwitch) {
            modeSwitch.addEventListener("change", async () => {
                const isChecked = modeSwitch.checked;
                const mode = isChecked ? "all" : "default";

                // 显示加载状态
                GPADisplay.textContent = "计算中...";
                tableBody.innerHTML = `<tr><td colspan="6">正在重新计算...</td></tr>`;

                try {
                    const response = await fetch("/recalc", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({mode: mode})
                    });

                    if (!response.ok) {
                        const errorMsg = await response.text();
                        toastBody.textContent = errorMsg || "未知错误";
                        toast.show()
                        return false;
                    }

                    const data = await response.json();
                    updatePage(data);
                } catch (error) {
                    GPADisplay.textContent = "计算失败";
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-danger">计算失败</td></tr>`;
                    toastBody.textContent = `意外异常: ${error.message}`;
                    toast.show();
                }
            });
        }

        // 普通提示型模态框元素
        const baseModal = new bootstrap.Modal(document.getElementById("base-modal"));
        const baseTitle = document.getElementById("base-modal-title");  // 标题
        const baseText = document.getElementById("base-modal-body-text");   // 正文
        const baseApiSpecified = document.getElementById("base-modal-url"); // 指定后端接口
        const baseBtn = document.getElementById("base-modal-submit");   // 确定按钮

        /** 以`POST`形式传输数据
         * @param {string} url 后端接口
         * @param {any} data 交互数据(可为空)
         * @return {Promise<Response>} 请求结果
         */
        function postData(url, data = null) {
            if (data === null) {
                return fetch(url, {method: "POST"});
            } else {
                return fetch(url, {method: "POST", body: data});
            }
        }

        /** 提交参数到指定后端接口
         * @param {string} choice 后端接口
         * @throws Error
         * @return {Promise<void>}
         */
        async function submitModalRequest(choice) {
            switch (choice) {
                case "/shutdown":
                    await postData(choice);

                    shutdownAlertPlaceholder.textContent = "程序已成功关闭，请手动关闭此浏览器选项卡。";
                    shutdownAlertPlaceholder.classList.add("alert-danger");
                    shutdownAlertPlaceholder.classList.remove("d-none");

                    shutdownBtn.textContent = "程序已关闭";
                    shutdownBtn.disabled = true;
                    modeSwitch.disabled = true;

                    break;
                case "/logout":
                    await postData(choice);
                    window.location.href = "/";
                    break;
                default:
                    throw new Error("内部错误: 接口参数异常");
            }
        }

        // 模态框按钮被点击
        baseBtn.addEventListener("click", async function () {
            const api = baseApiSpecified.value;
            try {
                this.disabled = true;
                await submitModalRequest(api);
            } catch (error) {
                toastBody.textContent = `发生错误: ${error.message}`;
                toast.show()
            } finally {
                baseModal.hide();
            }
        });

        // 关闭功能
        const shutdownBtn = document.getElementById("shutdown-button");
        const shutdownAlertPlaceholder = document.getElementById("shutdown-alert-placeholder-content");

        shutdownBtn.addEventListener("click", () => {
            baseTitle.textContent = "确认关闭程序吗？";
            baseText.textContent = "是否关闭此程序？关闭后，网页将不再响应后续操作，需要重新启动程序登录后才可继续使用。";
            baseApiSpecified.value = "/shutdown";
            baseBtn.className = "btn btn-danger";
            baseBtn.textContent = "确认关闭";
            baseBtn.disabled = false;
            baseModal.show();
        });

        // 注销会话
        const logoutBtn = document.getElementById("logout-button");

        logoutBtn.addEventListener("click", () => {
            baseTitle.textContent = "确认注销会话吗？";
            baseText.textContent = "将清除当前网页数据回到登录页。";
            baseApiSpecified.value = "/logout";
            baseBtn.className = "btn btn-warning";
            baseBtn.textContent = "确认";
            baseBtn.disabled = false;
            baseModal.show();
        });

        // 页面初始化
        const initialMode = modeSwitch ? "default" : "all";
        renderNotice(initialMode);
    });
</script>
{% endblock body %}